<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DietPlanner Pro</title>
    
    <!-- 設定 iOS 主畫面圖示 (Web App Icon) -->
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/kerryraquel/DietPlanner-Pro/779a5e3897b6b56bd41cb881843ddead207b6b05/healthy-food-logo-template-vector.jpg">
    <link rel="icon" type="image/jpeg" href="https://raw.githubusercontent.com/kerryraquel/DietPlanner-Pro/779a5e3897b6b56bd41cb881843ddead207b6b05/healthy-food-logo-template-vector.jpg">
    
    <!-- 設定 iOS Web App 模式 (移除瀏覽器網址列) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入 Babel (讓瀏覽器看懂 React) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 設定字型與背景 -->
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background-color: #f9fafb; /* 淺灰背景 */
            color: #1f2937;
            /* 針對 iOS 安全區域調整 */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        /* 隱藏捲軸但保持功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React 程式碼開始 -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Utensils, Calendar, ChevronRight, Info, 
            Flame, RefreshCw, Droplets, Plus, Minus, 
            ShoppingCart, Trash2, Search, ArrowLeft, Check, XCircle
        } from 'https://esm.sh/lucide-react@0.263.1';

        // --- 核心數據 ---
        const USER_STATS = {
            tdee: 1538,
            target_fast: 600,
            target_normal: 1350 
        };

        // --- 食譜資料 ---
        const FASTING_MENU = {
            Breakfast: { name: "輕斷食早餐", desc: "一隻雞蛋 + 200ml 牛奶 / 無糖乳酪", cal: 205 },
            Lunch: { name: "輕斷食午餐", desc: "半條粟米 + 100g 雞/牛肉 + 200g 蔬菜", cal: 290 },
            Dinner: { name: "蔬菜湯", desc: "清湯底 + 大量蔬菜 (無澱粉)", cal: 60 }
        };

        // 已加入新菜式
        const RAW_MAIN_LIST = [
            "Cobb Salad", "蝦仁芋絲青瓜雞蛋沙律", "Spicy Salmon poke bowl", "Miso Mushroom Coconut Milk Udon", 
            "Caesar Salad with chicken", "Shepherd’s Pie", "洋蔥木耳炒雞蛋", "意式蔬菜湯", "Toscana Salmon", 
            "花椒青椒炒雞丁", "蘋果炖豬扒", "酸辣薯絲燘牛肉", "地中海蝦翠玉瓜彩椒", "法式菌菇炖雞", 
            "芝士牛肉蔬菜鍋", "黑松露蘑菇蝦", "白蘑菇炒雞髀肉", "娃娃菜番茄粉絲燜牛肉", "番茄牛肉豆腐煲", 
            "粉絲節瓜蝦米", "蘆筍烤三文魚薯仔", "葡式蝦仁水牛芝士雞蛋沙律", "長邊豆南瓜雞肉", 
            "青瓜牛油果豆芽山羊芝士三文治", "牛油果雞肉希臘乳酪wrap", "牛油果芒果蝦仁聖女果沙律", 
            "貝貝南瓜蝦雞胸蘆筍紅蘿蔔薯仔空氣炸鍋", "烤薯仔蝦仁蘆筍白蘑菇", "烤椰菜BB紅薯雞蛋沙律", 
            "西蘭花牛肉炒烏冬", "粟米雞胸沙律", "烤椰菜配Romesco Sauce", "creamy garlic 西蘭花三文魚poke", 
            "蒜烤雞肉紅蘿蔔翠玉瓜薯仔西蘭花", "烤雞髀粟米，希臘沙律", "烤魚烚蛋蘆筍西蘭花薯仔", "silken tofu pasta", 
            "翠玉瓜+煙三文魚/煎蛋/蝦仁/雞胸+牛油果/生菜/甜椒+少量芝士碎卷餅", "娃娃菜雞蛋豆腐湯", 
            "娃娃菜粉絲炆牛肉", "辣味鮮蝦雜蔬", "蕃茄薯仔牛肉湯", "蘿蔔煎蛋湯", "蕃茄金針菇豆腐湯", 
            "菠菜雞蛋湯", "紫菜牛肉肉湯", "蕃茄炒蛋+清炒蔬菜", "蒜香蘑菇炆蝦仁/煎雞", "酸奶薯仔雞蛋沙律", 
            "翠玉瓜炒牛肉+炒豆芽", "蔬菜牛肉鍋", "Tunacado Sandwich", "地中海檸檬烤雞沙律", 
            "Creamy Chicken Corn Salad", "地中海風味蝦仁碗", "紅蘿蔔炒牛肉+炒椰菜 （主食Optional）", 
            "彩椒百蘑菇炒生菜雞肉 （主食Optional）", "青椒炒牛肉+炒法邊豆 （主食Optional）", 
            "牛油果雞肉沙律 （Wrap Optional）", "牛肉粒牛油果蕃茄洋蔥wrap", 
            "蒸水蛋 + 半拳粗糧 + 半拳蛋白質+ 炒蔬菜", "椰菜紅蘿蔔絲炒雞蛋（雞/牛肉 Optional）", 
            "Shrimp Avocado Lettuce Boats", "蝦仁芋絲西蘭花炒蛋", "Cucumber and Avocado Sandwich", 
            "Italian Frittata", "清蒸鱸魚+炒蔬菜", "日式鯖魚定食 （可選蒟蒻飯）", "滑蛋蝦仁蓋飯 （可選蒟蒻飯）", 
            "檸檬手撕雞千張或蒟蒻麵配烤蔬菜", "韓式泡菜豆腐蔬菜鍋", "墨西哥雞肉碗",
            "香煎雞腿蔬菜扁豆", "越式鮮蝦雜錦春卷", "藤椒牛肉粒炒時蔬", "清炖白蘿蔔牛肉湯", 
            "清炒蔬菜（200-250g）", "絲瓜雞蛋湯"
        ];

        const BREAKFAST_ONLY_NAMES = [
            "蝦仁芋絲青瓜雞蛋沙律", "洋蔥木耳炒雞蛋", "葡式蝦仁水牛芝士雞蛋沙律", 
            "半個粟米 / 無糖乳酪 / 雞蛋 / 半拳藍莓或一拳聖女果 四選二", "生菜雞蛋餅", "菠菜雞蛋卷", 
            "青瓜紅蘿蔔雞蛋卷", "南瓜牛奶雞蛋糕", "蘑菇蝦仁紅蘿蔔牛奶粟米湯", 
            "翠玉瓜+煙三文魚/煎蛋/蝦仁/雞胸+牛油果/生菜/甜椒+少量芝士碎卷餅", "酸奶薯仔雞蛋沙律", 
            "Tunacado Sandwich", "椰菜紅蘿蔔絲炒蛋（雞/牛肉 Optional）", "Shrimp Avocado Lettuce Boats", 
            "Cucumber and Avocado Sandwich", "Italian Frittata", 
            "Overnight rolled oats + milk + small amount of fruit"
        ];

        // --- 邏輯函數 ---
        const generateRecipeDB = () => {
            const allNames = new Set([...RAW_MAIN_LIST, ...BREAKFAST_ONLY_NAMES]);
            const db = [];
            allNames.forEach((name, index) => {
                const lowerName = name.toLowerCase();
                let category = "主食";
                let template = "StirFry"; 
                
                // 分類邏輯
                if (lowerName.includes("salad") || lowerName.includes("沙律") || lowerName.includes("poke") || lowerName.includes("bowl")) { category = "沙律/輕食"; template = "Salad"; }
                else if (lowerName.includes("soup") || lowerName.includes("湯") || lowerName.includes("鍋") || lowerName.includes("stew")) { category = "湯品/鍋物"; template = "Soup"; }
                else if (lowerName.includes("sandwich") || lowerName.includes("wrap") || lowerName.includes("三文治") || lowerName.includes("卷餅") || lowerName.includes("春卷") || lowerName.includes("boats")) { category = "輕食/麵包"; template = "Sandwich"; }
                else if (lowerName.includes("oats") || lowerName.includes("yogurt") || lowerName.includes("乳酪") || lowerName.includes("fruit") || lowerName.includes("cake") || lowerName.includes("蛋糕")) { category = "早餐"; template = "BreakfastBowl"; }
                else if (lowerName.includes("pasta") || lowerName.includes("udon") || lowerName.includes("麵") || lowerName.includes("飯")) { category = "麵飯"; template = "CarbMain"; }

                const variants = {};
                const baseCal = { L: 280, M: 450, H: 650 };
                if (template === "Soup") { baseCal.L = 220; baseCal.M = 400; baseCal.H = 600; }
                if (template === "Salad") { baseCal.L = 250; baseCal.M = 420; baseCal.H = 620; }

                // 特殊菜式卡路里調整
                if (name === "南瓜牛奶雞蛋糕") {
                    const specificText = "貝貝南瓜+蛋+奶+代糖蒸30分。冷藏過夜(抗性澱粉)，早餐翻叮";
                    variants.L = { cal: 250, text: "半個: " + specificText };
                    variants.M = { cal: 350, text: "一個: " + specificText };
                    variants.H = { cal: 450, text: "大個/加堅果: " + specificText };
                } 
                else if (name.includes("清炒蔬菜")) {
                    // 純蔬菜特別處理 (低卡)
                    variants.L = { cal: 90, text: "少油清炒 (150g)" };
                    variants.M = { cal: 140, text: "正常油量 (250g)" };
                    variants.H = { cal: 200, text: "加肉碎/蠔油 (300g)" };
                }
                else {
                    switch (template) {
                        case "Salad":
                            variants.L = { cal: baseCal.L, text: "大量蔬菜底 + 蛋白質(80g) + 醋汁 (走澱粉/堅果)" };
                            variants.M = { cal: baseCal.M, text: "蔬菜 + 蛋白質(100g) + 藜麥/薯仔(100g) + 油醋汁" };
                            variants.H = { cal: baseCal.H, text: "蔬菜 + 蛋白質(120g) + 澱粉 + 牛油果/堅果 + 濃醬汁" };
                            break;
                        case "Soup":
                            variants.L = { cal: baseCal.L, text: "清湯底 + 大量蔬菜 + 瘦肉/豆腐 (無主食/粉絲)" };
                            variants.M = { cal: baseCal.M, text: "正常湯底 + 肉類 + 粉絲/薯仔(100g)" };
                            variants.H = { cal: baseCal.H, text: "濃湯底/加椰奶 + 肉類 + 飯/麵包 + 芝士" };
                            break;
                        case "Sandwich":
                            variants.L = { cal: baseCal.L, text: "生菜包/米紙卷代替麵包 + 餡料 + 走醬" };
                            variants.M = { cal: baseCal.M, text: "全麥麵包1片/餅皮/春卷皮 + 正常餡料 + 少量醬" };
                            variants.H = { cal: baseCal.H, text: "麵包2片/大餅皮 + 雙倍餡料 + 芝士/牛油果" };
                            break;
                        case "BreakfastBowl":
                            variants.L = { cal: 250, text: "半份份量 + 無糖 + 僅少量水果" };
                            variants.M = { cal: 400, text: "正常份量 + 牛奶/豆漿 + 堅果" };
                            variants.H = { cal: 550, text: "大份量 + 全脂奶 + 豐富配料/蜂蜜" };
                            break;
                        case "CarbMain": 
                            variants.L = { cal: 300, text: "蒟蒻麵/椰菜花飯代替主食 + 少油 + 瘦肉" };
                            variants.M = { cal: 500, text: "正常飯/麵(120g) + 正常肉量" };
                            variants.H = { cal: 700, text: "飯/麵(200g) + 加蛋/加肉 + 濃汁" };
                            break;
                        default: 
                            variants.L = { cal: 300, text: "只吃餸(走汁) + 補充大量烚菜 (無飯)" };
                            variants.M = { cal: 500, text: "餸菜 + 飯(100g) / 薯仔" };
                            variants.H = { cal: 700, text: "餸菜(份量加大) + 飯(180g) + 醬汁" };
                    }
                    if (name.includes("Optional")) {
                        variants.L.text = "不加 Optional 選項 (如主食/餅皮)";
                        variants.M.text = "加半份 Optional 選項";
                        variants.H.text = "加全份 Optional 選項";
                    }
                }
                db.push({ id: `gen_${index}`, name: name, category: category, variants: variants });
            });
            return db;
        };

        const RECIPE_DB = generateRecipeDB();
        const DAYS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

        const getRandomRecipe = (excludeIds = [], filterFn = null) => {
            let available = RECIPE_DB.filter(r => !excludeIds.includes(r.id));
            if (filterFn) available = available.filter(filterFn);
            if (available.length === 0) available = RECIPE_DB.filter(filterFn || (() => true));
            if (available.length === 0) return RECIPE_DB[0];
            return available[Math.floor(Math.random() * available.length)];
        };

        const generateInitialPlan = () => {
            const plan = [];
            const usedRecipeIds = [];
            DAYS.forEach((day, idx) => {
                const isWeekend = idx >= 5;
                const isFast = (idx === 0 || idx === 3); 
                const meals = [];
                const mealTypes = isWeekend ? ['Brunch', 'Dinner'] : ['Breakfast', 'Lunch', 'Dinner'];

                mealTypes.forEach(type => {
                    if (isFast) {
                        let fastMealData;
                        if (type === 'Breakfast') fastMealData = FASTING_MENU.Breakfast;
                        else if (type === 'Lunch') fastMealData = FASTING_MENU.Lunch;
                        else fastMealData = FASTING_MENU.Dinner;
                        meals.push({ type, isFastMeal: true, name: fastMealData.name, desc: fastMealData.desc, cal: fastMealData.cal, skipped: false });
                    } else {
                        let recipe;
                        if (type === 'Breakfast' || type === 'Brunch') recipe = getRandomRecipe(usedRecipeIds, (r) => BREAKFAST_ONLY_NAMES.includes(r.name));
                        else recipe = getRandomRecipe(usedRecipeIds, (r) => !r.name.includes("oats") && !r.name.includes("cake"));
                        if (recipe) {
                            usedRecipeIds.push(recipe.id);
                            if (usedRecipeIds.length > RECIPE_DB.length - 10) usedRecipeIds.length = 0;
                            meals.push({ type, isFastMeal: false, recipe, size: 'M' });
                        }
                    }
                });
                plan.push({ day, fullDay: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'][idx], isWeekend, isFast, water: 0, meals });
            });
            return plan;
        };

        // --- 主應用程式 ---
        function DietPlannerPro() {
            const [weekPlan, setWeekPlan] = useState([]);
            const [shoppingList, setShoppingList] = useState([]);
            const [newItemText, setNewItemText] = useState("");
            const [selectedSlot, setSelectedSlot] = useState(null); 
            const [view, setView] = useState('plan'); 
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => { setWeekPlan(generateInitialPlan()); }, []);

            const dailyStats = useMemo(() => {
                return weekPlan.map(day => {
                    let totalCal = 0;
                    day.meals.forEach(meal => {
                        if (meal.isFastMeal) { if (!meal.skipped) totalCal += meal.cal; } 
                        else if (meal.recipe) { totalCal += meal.recipe.variants[meal.size].cal; }
                    });
                    const target = day.isFast ? USER_STATS.target_fast : USER_STATS.target_normal;
                    return { totalCal, target, isOver: totalCal > target };
                });
            }, [weekPlan]);

            const toggleFastDay = (dayIndex) => {
                const newPlan = [...weekPlan];
                const isNowFast = !newPlan[dayIndex].isFast;
                newPlan[dayIndex].isFast = isNowFast;
                const mealTypes = newPlan[dayIndex].isWeekend ? ['Brunch', 'Dinner'] : ['Breakfast', 'Lunch', 'Dinner'];
                const newMeals = [];
                mealTypes.forEach(type => {
                    if (isNowFast) {
                        let fastMealData;
                        if (type === 'Breakfast' || type === 'Brunch') fastMealData = FASTING_MENU.Breakfast;
                        else if (type === 'Lunch') fastMealData = FASTING_MENU.Lunch;
                        else fastMealData = FASTING_MENU.Dinner;
                        newMeals.push({ type, isFastMeal: true, name: fastMealData.name, desc: fastMealData.desc, cal: fastMealData.cal, skipped: false });
                    } else {
                        let recipe;
                        if (type === 'Breakfast' || type === 'Brunch') recipe = getRandomRecipe([], (r) => BREAKFAST_ONLY_NAMES.includes(r.name));
                        else recipe = getRandomRecipe([], (r) => !r.name.includes("oats"));
                        newMeals.push({ type, isFastMeal: false, recipe, size: 'M' });
                    }
                });
                newPlan[dayIndex].meals = newMeals;
                setWeekPlan(newPlan);
            };

            const changeSize = (dayIndex, mealIndex, size) => {
                const newPlan = [...weekPlan];
                if (!newPlan[dayIndex].meals[mealIndex].isFastMeal) {
                    newPlan[dayIndex].meals[mealIndex].size = size;
                    setWeekPlan(newPlan);
                }
            };

            const toggleSkipMeal = (dayIndex, mealIndex) => {
                const newPlan = [...weekPlan];
                const meal = newPlan[dayIndex].meals[mealIndex];
                if (meal.isFastMeal) {
                    meal.skipped = !meal.skipped;
                    setWeekPlan(newPlan);
                }
            };

            const selectRecipe = (recipe) => {
                if (!selectedSlot) return;
                const { dayIndex, mealIndex } = selectedSlot;
                const newPlan = [...weekPlan];
                newPlan[dayIndex].meals[mealIndex] = { type: newPlan[dayIndex].meals[mealIndex].type, isFastMeal: false, recipe: recipe, size: 'M' };
                setWeekPlan(newPlan);
                setView('plan');
                setSelectedSlot(null);
            };

            const updateWater = (dayIndex, delta) => {
                const newPlan = [...weekPlan];
                newPlan[dayIndex].water = Math.max(0, newPlan[dayIndex].water + delta);
                setWeekPlan(newPlan);
            };

            const addShoppingItem = () => {
                if (!newItemText.trim()) return;
                setShoppingList([...shoppingList, { id: Date.now(), text: newItemText, checked: false }]);
                setNewItemText("");
            };

            const toggleShoppingItem = (id) => {
                setShoppingList(shoppingList.map(item => item.id === id ? { ...item, checked: !item.checked } : item));
            };

            const deleteShoppingItem = (id) => {
                setShoppingList(shoppingList.filter(item => item.id !== id));
            };

            const regeneratePlan = () => {
                if(window.confirm("確定要重新生成本週計畫嗎？")) { setWeekPlan(generateInitialPlan()); }
            };

            const getFilteredRecipes = () => {
                let filtered = RECIPE_DB.filter(r => r.name.toLowerCase().includes(searchTerm.toLowerCase()));
                if (selectedSlot) {
                    const currentMealType = weekPlan[selectedSlot.dayIndex].meals[selectedSlot.mealIndex].type;
                    if (currentMealType === 'Breakfast' || currentMealType === 'Brunch') filtered = filtered.filter(r => BREAKFAST_ONLY_NAMES.includes(r.name));
                }
                return filtered;
            };

            if (weekPlan.length === 0) return <div className="p-10 text-center">Loading Plan...</div>;

            return (
                <div className="max-w-md mx-auto bg-white min-h-screen shadow-2xl overflow-hidden flex flex-col font-sans">
                    
                    {/* Header Area */}
                    <div className="bg-white pt-6 pb-2 px-4 flex flex-col items-center justify-center">
                        <div className="flex items-center gap-3 mb-6">
                            {/* Logo 圖片 - 使用相同的 GitHub Raw 連結 */}
                            <div className="w-12 h-12 rounded-xl overflow-hidden shadow-sm">
                                <img 
                                    src="https://raw.githubusercontent.com/kerryraquel/DietPlanner-Pro/779a5e3897b6b56bd41cb881843ddead207b6b05/healthy-food-logo-template-vector.jpg" 
                                    alt="Logo" 
                                    className="w-full h-full object-cover"
                                    onError={(e) => {
                                        e.target.style.display = 'none';
                                        e.target.parentNode.innerHTML = '<div class="w-full h-full bg-emerald-100 flex items-center justify-center text-emerald-600"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4.5 9l5 5 10-10"/></svg></div>';
                                    }}
                                />
                            </div>
                            <h1 className="text-2xl font-bold text-gray-800 tracking-tight">
                                DietPlanner <span className="text-emerald-600">Pro</span>
                            </h1>
                        </div>

                        {/* 兩張大的數據卡片 */}
                        <div className="grid grid-cols-2 gap-4 w-full mb-2">
                            {/* TDEE 卡片 */}
                            <div className="bg-green-50 rounded-2xl p-5 flex flex-col items-center justify-center border border-green-100 shadow-sm">
                                <span className="text-emerald-700 font-bold text-xs mb-1 tracking-wide">TDEE 目標</span>
                                <div className="flex items-baseline">
                                    <span className="text-3xl font-black text-gray-800">{USER_STATS.tdee}</span>
                                    <span className="text-sm text-gray-500 ml-1 font-medium">kcal</span>
                                </div>
                            </div>
                            
                            {/* 輕斷食卡片 */}
                            <div className="bg-purple-50 rounded-2xl p-5 flex flex-col items-center justify-center border border-purple-100 shadow-sm">
                                <span className="text-purple-700 font-bold text-xs mb-1 tracking-wide">輕斷食限制</span>
                                <div className="flex items-baseline">
                                    <span className="text-3xl font-black text-gray-800">{USER_STATS.target_fast}</span>
                                    <span className="text-sm text-gray-500 ml-1 font-medium">kcal</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 overflow-y-auto bg-white p-4 pb-24">
                        
                        {/* VIEW: PLAN */}
                        {view === 'plan' && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center mt-2">
                                    <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                                        <Calendar className="w-5 h-5 text-gray-700" />
                                        本週計畫
                                    </h2>
                                    <button 
                                        onClick={regeneratePlan}
                                        className="text-xs flex items-center gap-1 text-gray-400 hover:text-emerald-600 transition-colors font-medium"
                                    >
                                        <RefreshCw className="w-3 h-3" />
                                        重新生成
                                    </button>
                                </div>

                                {weekPlan.map((day, dIdx) => {
                                    const stats = dailyStats[dIdx];
                                    return (
                                        <div key={dIdx} className={`rounded-3xl p-5 shadow-[0_2px_15px_-3px_rgba(0,0,0,0.05)] border transition-all ${day.isFast ? 'border-purple-100 bg-purple-50/20' : 'border-gray-100 bg-white'}`}>
                                            {/* Day Header */}
                                            <div className="flex justify-between items-center mb-4">
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold shadow-sm ${day.isFast ? 'bg-purple-100 text-purple-600' : 'bg-emerald-100 text-emerald-600'}`}>
                                                        {day.day}
                                                    </div>
                                                    <div>
                                                        <div className="flex items-center gap-2">
                                                            <span className="font-bold text-gray-800">{day.fullDay}</span>
                                                            {day.isWeekend && <span className="text-[10px] bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full">休息日</span>}
                                                        </div>
                                                        <div className={`text-xs font-medium mt-0.5 ${stats.isOver ? 'text-red-500' : 'text-gray-400'}`}>
                                                            {stats.totalCal} / {stats.target} kcal
                                                        </div>
                                                    </div>
                                                </div>
                                                <button 
                                                    onClick={() => toggleFastDay(dIdx)}
                                                    className={`text-[10px] px-3 py-1.5 rounded-full font-bold transition-colors border ${day.isFast ? 'bg-purple-500 text-white border-purple-500' : 'bg-white text-gray-400 border-gray-200'}`}
                                                >
                                                    {day.isFast ? '輕斷食 ON' : '輕斷食 OFF'}
                                                </button>
                                            </div>

                                            {/* Water Tracker */}
                                            <div className="flex items-center justify-between bg-blue-50/50 px-3 py-2 rounded-xl mb-4">
                                                <div className="flex items-center gap-2 text-blue-500">
                                                    <Droplets className="w-4 h-4" />
                                                    <span className="text-xs font-bold">飲水</span>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <button onClick={() => updateWater(dIdx, -200)} className="w-6 h-6 rounded-full bg-white text-blue-400 shadow-sm flex items-center justify-center hover:bg-blue-50"><Minus className="w-3 h-3" /></button>
                                                    <span className="text-sm font-bold text-blue-600 w-10 text-center">{day.water}</span>
                                                    <button onClick={() => updateWater(dIdx, 200)} className="w-6 h-6 rounded-full bg-white text-blue-400 shadow-sm flex items-center justify-center hover:bg-blue-50"><Plus className="w-3 h-3" /></button>
                                                </div>
                                            </div>

                                            {/* Meals */}
                                            <div className="space-y-4">
                                                {day.meals.map((meal, mIdx) => (
                                                    <div key={mIdx} className="relative">
                                                        <div className="flex justify-between items-center mb-1">
                                                            <span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">{meal.type}</span>
                                                            <button 
                                                                onClick={() => { setSelectedSlot({ dayIndex: dIdx, mealIndex: mIdx }); setView('recipes'); }}
                                                                className="text-[10px] text-emerald-600 font-bold hover:text-emerald-700"
                                                            >
                                                                更換
                                                            </button>
                                                        </div>
                                                        
                                                        {meal.isFastMeal ? (
                                                            <div className={`p-3 rounded-2xl text-sm border ${meal.skipped ? 'bg-gray-50 border-gray-100 text-gray-400' : 'bg-white border-purple-100 shadow-sm'}`}>
                                                                <div className="font-bold flex items-center justify-between">
                                                                    <span className={meal.skipped ? 'line-through' : 'text-gray-800'}>{meal.name}</span>
                                                                    {meal.type === 'Dinner' && (
                                                                        <button onClick={() => toggleSkipMeal(dIdx, mIdx)} className={`ml-2 px-2 py-0.5 rounded text-[10px] font-bold border ${meal.skipped ? 'bg-gray-200 text-gray-600' : 'bg-purple-50 text-purple-600 border-purple-100'}`}>
                                                                            {meal.skipped ? '恢復' : 'Skip'}
                                                                        </button>
                                                                    )}
                                                                </div>
                                                                {!meal.skipped && <div className="text-xs text-gray-500 mt-1">{meal.desc}</div>}
                                                                <div className="text-xs font-bold text-right mt-1 text-purple-400">{meal.skipped ? '0' : meal.cal} kcal</div>
                                                            </div>
                                                        ) : (
                                                            <div className="bg-white p-3 rounded-2xl border border-gray-100 shadow-sm">
                                                                <div className="font-bold text-gray-800 text-sm mb-1">{meal.recipe.name}</div>
                                                                <div className="text-xs text-gray-500 mb-2 leading-relaxed">
                                                                    <span className="text-emerald-600 font-bold mr-1">建議:</span>
                                                                    {meal.recipe.variants[meal.size].text}
                                                                </div>
                                                                <div className="flex justify-between items-center mt-2 pt-2 border-t border-gray-50">
                                                                    <div className="flex gap-1">
                                                                        {['L', 'M', 'H'].map(size => (
                                                                            <button key={size} onClick={() => changeSize(dIdx, mIdx, size)} className={`w-6 h-6 text-[10px] font-bold rounded-lg transition-all ${meal.size === size ? (size === 'L' ? 'bg-green-500 text-white' : size === 'M' ? 'bg-blue-500 text-white' : 'bg-orange-500 text-white') : 'bg-gray-50 text-gray-400'}`}>{size}</button>
                                                                        ))}
                                                                    </div>
                                                                    <span className="text-xs font-bold text-gray-400">~{meal.recipe.variants[meal.size].cal} kcal</span>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}

                        {/* VIEW: RECIPES */}
                        {view === 'recipes' && (
                            <div className="space-y-4 animate-in slide-in-from-right duration-300">
                                <div className="sticky top-0 bg-white pt-2 pb-4 z-10 border-b border-gray-50">
                                    <button onClick={() => setView('plan')} className="flex items-center text-gray-500 hover:text-emerald-600 mb-4 font-bold text-sm">
                                        <ArrowLeft className="w-4 h-4 mr-1" /> 返回計畫
                                    </button>
                                    <div className="relative">
                                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" />
                                        <input type="text" placeholder="搜尋食譜..." className="w-full pl-10 pr-4 py-3 rounded-xl bg-gray-50 border-none text-sm focus:ring-2 focus:ring-emerald-500" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                                    </div>
                                </div>
                                <h3 className="font-bold text-gray-700 px-1">
                                    {selectedSlot && (weekPlan[selectedSlot.dayIndex].meals[selectedSlot.mealIndex].type === 'Breakfast' || weekPlan[selectedSlot.dayIndex].meals[selectedSlot.mealIndex].type === 'Brunch') ? "選擇早餐" : "選擇餐點"}
                                </h3>
                                <div className="grid gap-3">
                                    {getFilteredRecipes().map(recipe => (
                                        <button key={recipe.id} onClick={() => selectRecipe(recipe)} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 text-left hover:border-emerald-400 transition-colors group">
                                            <div className="flex justify-between items-start mb-1">
                                                <span className="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded-full font-bold">{recipe.category}</span>
                                                <ChevronRight className="w-4 h-4 text-gray-300 group-hover:text-emerald-500" />
                                            </div>
                                            <div className="font-bold text-gray-800">{recipe.name}</div>
                                            <div className="text-xs text-gray-400 mt-1">M號: ~{recipe.variants.M.cal} kcal</div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* VIEW: SHOPPING LIST */}
                        {view === 'shopping' && (
                            <div className="space-y-4 animate-in fade-in duration-300">
                                <h2 className="text-lg font-bold text-gray-700 flex items-center gap-2 px-1">
                                    <ShoppingCart className="w-5 h-5 text-emerald-500" />
                                    購物清單
                                </h2>
                                <div className="bg-white p-2 rounded-xl shadow-sm flex gap-2 border border-gray-100">
                                    <input type="text" placeholder="手動輸入..." className="flex-1 bg-transparent border-none focus:ring-0 text-sm px-2" value={newItemText} onChange={(e) => setNewItemText(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && addShoppingItem()} />
                                    <button onClick={addShoppingItem} className="bg-emerald-500 text-white p-2 rounded-lg hover:bg-emerald-600"><Plus className="w-4 h-4" /></button>
                                </div>
                                <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                                    {shoppingList.length === 0 ? (
                                        <div className="p-8 text-center text-gray-400 text-sm">
                                            <ShoppingCart className="w-8 h-8 mx-auto mb-2 opacity-20" />
                                            <p>清單是空的</p>
                                        </div>
                                    ) : (
                                        <div className="divide-y divide-gray-50">
                                            {shoppingList.map(item => (
                                                <div key={item.id} className="flex items-center justify-between p-4 hover:bg-gray-50 group">
                                                    <div className="flex items-center gap-3">
                                                        <button onClick={() => toggleShoppingItem(item.id)} className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${item.checked ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-gray-300 text-transparent'}`}><Check className="w-3 h-3" /></button>
                                                        <span className={`text-sm ${item.checked ? 'text-gray-400 line-through' : 'text-gray-700'}`}>{item.text}</span>
                                                    </div>
                                                    <button onClick={() => deleteShoppingItem(item.id)} className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 className="w-4 h-4" /></button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                <div className="bg-blue-50 p-4 rounded-xl flex gap-3 text-blue-700 text-xs leading-relaxed">
                                    <Info className="w-4 h-4 flex-shrink-0 mt-0.5" />
                                    <p><span className="font-bold block mb-1">提示：</span>查看食譜時，請留意你選擇的份量 (L/M/H)。</p>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Bottom Navigation */}
                    <div className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-gray-100 p-2 pb-6 flex justify-around items-center z-50 max-w-md mx-auto">
                        <button onClick={() => setView('plan')} className={`flex flex-col items-center gap-1 transition-colors ${view === 'plan' ? 'text-emerald-600' : 'text-gray-400'}`}>
                            <Calendar className={`w-6 h-6 ${view === 'plan' ? 'fill-emerald-100' : ''}`} />
                            <span className="text-[10px] font-bold">計畫</span>
                        </button>
                        <div className="w-px h-8 bg-gray-100"></div>
                        <button onClick={() => setView('shopping')} className={`flex flex-col items-center gap-1 transition-colors ${view === 'shopping' ? 'text-emerald-600' : 'text-gray-400'}`}>
                            <ShoppingCart className={`w-6 h-6 ${view === 'shopping' ? 'fill-emerald-100' : ''}`} />
                            <span className="text-[10px] font-bold">購物</span>
                        </button>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<DietPlannerPro />);
    </script>
</body>
</html>
