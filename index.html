<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DietPlanner Pro - Metabolic Reset</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #F9FAFB;
            color: #1F2937;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
        }
        
        /* --- Day Card Design --- */
        .day-card-new {
            background: white;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease;
            border: 1px solid #F3F4F6;
            height: 64px;
        }
        
        .day-card-active {
            border: 2px solid #1F2937;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .corner-badge {
            position: absolute;
            top: 0;
            right: 0;
            width: 24px;
            height: 24px;
            border-bottom-left-radius: 12px;
        }

        /* --- Meal Card --- */
        .meal-card {
            background: #FFFFFF;
            border: 1px solid #F3F4F6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            border-radius: 1.25rem;
            transition: all 0.3s ease;
        }
        .meal-skipped {
            opacity: 0.8; 
            background-color: #FFF7ED; 
            border-style: dashed;
            border-color: #FDBA74;
        }

        /* --- Water Card Styles --- */
        .water-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .water-success-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 4px 20px rgba(250, 204, 21, 0.15);
            border: 1px solid #FEF9C3;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .water-dash {
            height: 6px;
            border-radius: 4px;
            background-color: #FDE047;
            flex: 1;
        }

        /* Nut Button */
        .nut-btn {
            transition: all 0.2s ease;
        }
        .nut-active {
            background-color: #78350F;
            color: white;
            border-color: #78350F;
        }
        .nut-inactive {
            background-color: #FFFBEB;
            color: #92400E;
            border-color: #FEF3C7;
        }

        .tip-box {
            background-color: #FFFBEB;
            border-radius: 0.5rem;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
    </style>
</head>
<body class="pb-32">

    <!-- Header -->
    <div class="sticky top-0 z-40 bg-white/95 backdrop-blur-md border-b border-gray-100 pt-4 pb-2 px-4">
        <div class="flex justify-between items-center mb-3">
            <div>
                <h1 class="text-lg font-bold text-gray-900 tracking-tight">DietPlanner <span class="text-orange-500">Pro</span></h1>
            </div>
            
            <button onclick="window.toggleMenu()" class="group relative w-9 h-9 rounded-full transition-transform active:scale-95">
                <svg width="36" height="36" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="20" fill="#FFF7ED"/>
                    <path d="M14 11V18C14 19.6569 15.3431 21 17 21H17.5" stroke="#EA580C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M14 11V15" stroke="#EA580C" stroke-width="2" stroke-linecap="round"/>
                    <path d="M17 11V18" stroke="#EA580C" stroke-width="2" stroke-linecap="round"/>
                    <path d="M20 11V18C20 19.6569 18.6569 21 17 21" stroke="#EA580C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M17 21V29" stroke="#EA580C" stroke-width="2" stroke-linecap="round"/>
                    <path d="M26 11V29" stroke="#EA580C" stroke-width="2" stroke-linecap="round"/>
                    <path d="M26 11C26 11 23 11 23 16V21H26" stroke="#EA580C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>

        <!-- Day Slider (Grid Layout) -->
        <div class="grid grid-cols-7 gap-1.5 mb-4" id="day-slider">
            <!-- JS Injected -->
        </div>

        <!-- Water Tracker (Dynamic) -->
        <div id="water-container">
            <!-- JS Injected -->
        </div>
    </div>

    <!-- Dashboard -->
    <div class="px-4 mt-4">
        <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
            <!-- Top Row: Title, Nut, Toggle -->
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center space-x-2">
                    <h2 class="text-base font-bold text-gray-900">ä»Šæ—¥èƒ½é‡ç›®æ¨™</h2>
                    <span id="day-type-badge" class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider"></span>
                </div>
                
                <div class="flex items-center space-x-2">
                    <!-- Brazil Nut Button -->
                    <button id="nut-btn" onclick="window.toggleBrazilNut()" class="nut-btn flex items-center space-x-1 px-2 py-1 rounded-full border text-[10px] font-bold shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20Z"/></svg>
                        <span>å·´è¥¿å …æœ</span>
                    </button>

                    <!-- Mode Toggle -->
                    <label class="relative inline-flex items-center cursor-pointer ml-1">
                        <input type="checkbox" id="mode-toggle" class="sr-only peer" onchange="window.toggleMode()">
                        <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-orange-500"></div>
                    </label>
                </div>
            </div>

            <div class="flex justify-between items-end mb-4">
                <div class="text-[10px] font-medium text-gray-400" id="mode-label">Standard</div>
                <div class="text-2xl font-bold text-gray-900 leading-none tracking-tight">
                    <span id="cal-current">0</span><span class="text-xs text-gray-400 font-normal"> / <span id="cal-target">1225</span></span>
                </div>
            </div>

            <!-- Macros -->
            <div class="space-y-3">
                <!-- Protein -->
                <div>
                    <div class="flex justify-between text-[10px] mb-1">
                        <span class="font-medium text-gray-500">è›‹ç™½è³ª (Protein)</span>
                        <span class="text-gray-400"><span id="prot-current" class="text-gray-900 font-bold">0</span> / <span id="prot-target">115g</span></span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                        <div id="prot-bar" class="h-full rounded-full bg-blue-500 transition-all duration-700" style="width: 0%"></div>
                    </div>
                </div>
                <!-- Carbs -->
                <div>
                    <div class="flex justify-between text-[10px] mb-1">
                        <span class="font-medium text-gray-500">ç¢³æ°´åŒ–åˆç‰© (Carbs)</span>
                        <span class="text-gray-400"><span id="carb-current" class="text-gray-900 font-bold">0</span> / <span id="carb-target">100g</span></span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                        <div id="carb-bar" class="h-full rounded-full bg-yellow-400 transition-all duration-700" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Strategy Text -->
            <div class="mt-3 pt-3 border-t border-gray-50">
                <p class="text-[11px] text-gray-500 leading-relaxed" id="strategy-desc">
                    <!-- JS Injected -->
                </p>
            </div>
        </div>
    </div>

    <!-- Meals List -->
    <div class="px-4 mt-5 space-y-4" id="meals-container">
        <!-- JS Injected -->
    </div>

    <!-- Full Menu Drawer -->
    <div id="menu-modal" class="fixed inset-0 z-50 hidden transition-opacity duration-300" style="background-color: rgba(0,0,0,0.2); backdrop-filter: blur(2px);">
        <div class="absolute inset-y-0 right-0 w-full max-w-md bg-white shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col" id="menu-drawer">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-white z-10">
                <div>
                    <h2 class="text-lg font-bold text-gray-900">å®Œæ•´èœå–®è³‡æ–™åº«</h2>
                </div>
                <button onclick="window.toggleMenu()" class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-500 hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-5 space-y-8">
                <div id="full-menu-list">
                    <!-- JS Injected -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Icons ---
        const ICONS = {
            coffee: 'â˜•ï¸',
            sun: 'â˜€ï¸',
            moon: 'ğŸŒ™',
            refresh: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>`,
            close: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
            restore: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>`,
            check: `<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
            bulb: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-400"><path d="M12,2A7,7,0,0,0,5,9c0,4.2,2.33,5.56,3,8.75A1,1,0,0,0,9,19h6a1,1,0,0,0,1-1.25C16.67,14.56,19,13.2,19,9A7,7,0,0,0,12,2ZM15,17H9c-.27-1.35-1.25-2.28-1.89-3.71A9.78,9.78,0,0,1,6.1,9.39,5.92,5.92,0,0,1,12,4a5.92,5.92,0,0,1,5.9,5.39,9.78,9.78,0,0,1-1,3.9C16.25,14.72,15.27,15.65,15,17Zm-6,4a1,1,0,0,0,1,1h4a1,1,0,0,0,1-1v-1H9Z"/></svg>`,
            fire: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a5.5 5.5 0 11-11 0c0-3.03.412-5.843 1.225-8.047C8.79 8.253 8.5 9.46 8.5 10.5c0 .93.41 1.84 1 2.5z"/></svg>`,
            leaf: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/></svg>`,
            run: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`
        };

        const RAW_RECIPES = [
            "Cajuné¦™æ–™é›é«€é£¯", "è¦ä»èŠ‹çµ²é’ç“œé›è›‹æ²™å¾‹", "Spicy Salmon poke bowl", "Miso Mushroom Coconut Milk Udon", "Caesar Salad with chicken",
            "Shepherdâ€™s Pie", "æ´‹è”¥æœ¨è€³ç‚’é›è›‹", "æ„å¼è”¬èœæ¹¯", "Toscana Salmon", "èŠ±æ¤’é’æ¤’ç‚’é›ä¸",
            "è˜‹æœç‚–è±¬æ‰’", "é…¸è¾£è–¯çµ²ç‡˜ç‰›è‚‰", "åœ°ä¸­æµ·è¦ç¿ ç‰ç“œå½©æ¤’", "æ³•å¼èŒè‡ç‚–é›", "èŠå£«ç‰›è‚‰è”¬èœé‹",
            "é»‘æ¾éœ²è˜‘è‡è¦", "ç™½è˜‘è‡ç‚’é›é«€è‚‰", "å¨ƒå¨ƒèœç•ªèŒ„ç²‰çµ²ç‡œç‰›è‚‰", "ç•ªèŒ„ç‰›è‚‰è±†è…ç…²", "ç²‰çµ²ç¯€ç“œè¦ç±³",
            "è˜†ç­çƒ¤ä¸‰æ–‡é­šè–¯ä»”", "è‘¡å¼è¦ä»æ°´ç‰›èŠå£«é›è›‹æ²™å¾‹", "é•·é‚Šè±†å—ç“œé›è‚‰", "é’ç“œç‰›æ²¹æœè±†èŠ½å±±ç¾ŠèŠå£«ä¸‰æ–‡æ²»", "ç‰›æ²¹æœé›è‚‰å¸Œè‡˜ä¹³é…ªwrap",
            "ç‰›æ²¹æœèŠ’æœè¦ä»è–å¥³æœæ²™å¾‹", "è²è²å—ç“œè¦é›èƒ¸è˜†ç­ç´…è˜¿è””è–¯ä»”ç©ºæ°£ç‚¸é‹", "çƒ¤è–¯ä»”è¦ä»è˜†ç­ç™½è˜‘è‡", "çƒ¤æ¤°èœBBç´…è–¯é›è›‹æ²™å¾‹", "è¥¿è˜­èŠ±ç‰›è‚‰ç‚’çƒå†¬",
            "ç²Ÿç±³é›èƒ¸æ²™å¾‹", "çƒ¤æ¤°èœé…Romesco Sauce", "creamy garlic è¥¿è˜­èŠ±ä¸‰æ–‡é­špoke", "è’œçƒ¤é›è‚‰ç´…è˜¿è””ç¿ ç‰ç“œè–¯ä»”è¥¿è˜­èŠ±", "çƒ¤é›é«€ç²Ÿç±³ï¼Œå¸Œè‡˜æ²™å¾‹",
            "çƒ¤é­šçƒšè›‹è˜†ç­è¥¿è˜­èŠ±è–¯ä»”", "silken tofu pasta", "ç¿ ç‰ç“œ+ç…™ä¸‰æ–‡é­š/ç…è›‹/è¦ä»/é›èƒ¸+ç‰›æ²¹æœ/ç”Ÿèœ/ç”œæ¤’+å°‘é‡èŠå£«ç¢å·é¤…", "å¨ƒå¨ƒèœé›è›‹è±†è…æ¹¯", "å¨ƒå¨ƒèœç²‰çµ²ç‚†ç‰›è‚‰",
            "è¾£å‘³é®®è¦é›œè”¬", "è•ƒèŒ„è–¯ä»”ç‰›è‚‰æ¹¯", "è˜¿è””ç…è›‹æ¹¯", "è•ƒèŒ„é‡‘é‡è‡è±†è…æ¹¯", "è èœé›è›‹æ¹¯",
            "ç´«èœç‰›è‚‰è‚‰æ¹¯", "è•ƒèŒ„ç‚’è›‹+æ¸…ç‚’è”¬èœ", "è’œé¦™è˜‘è‡ç‚†è¦ä»/ç…é›", "é…¸å¥¶è–¯ä»”é›è›‹æ²™å¾‹", "ç¿ ç‰ç“œç‚’ç‰›è‚‰+ç‚’è±†èŠ½",
            "è”¬èœç‰›è‚‰é‹", "Tunacado Sandwich", "åœ°ä¸­æµ·æª¸æª¬çƒ¤é›æ²™å¾‹", "Creamy Chicken Corn Salad", "åœ°ä¸­æµ·é¢¨å‘³è¦ä»ç¢—",
            "ç´…è˜¿è””ç‚’ç‰›è‚‰+ç‚’æ¤°èœ", "å½©æ¤’ç™¾è˜‘è‡ç‚’ç”Ÿèœé›è‚‰", "é’æ¤’ç‚’ç‰›è‚‰+ç‚’æ³•é‚Šè±†", "ç‰›æ²¹æœé›è‚‰æ²™å¾‹", "ç‰›è‚‰ç²’ç‰›æ²¹æœè•ƒèŒ„æ´‹è”¥wrap",
            "è’¸æ°´è›‹ + åŠæ‹³ç²—ç³§ + åŠæ‹³è›‹ç™½è³ª+ ç‚’è”¬èœ", "æ¤°èœç´…è˜¿è””çµ²ç‚’é›è›‹", "Shrimp Avocado Lettuce Boats", "è¦ä»èŠ‹çµ²è¥¿è˜­èŠ±ç‚’è›‹", "Cucumber and Avocado Sandwich",
            "Italian Frittata", "æ¸…è’¸é±¸é­š+ç‚’è”¬èœ", "æ—¥å¼é¯–é­šå®šé£Ÿ", "æ»‘è›‹è¦ä»è“‹é£¯", "æª¸æª¬æ‰‹æ’•é›åƒå¼µæˆ–è’Ÿè’»éºµé…çƒ¤è”¬èœ",
            "éŸ“å¼æ³¡èœè±†è…è”¬èœé‹", "å¢¨è¥¿å“¥é›è‚‰ç¢—", "é¦™ç…é›è…¿è”¬èœæ‰è±†", "è¶Šå¼é®®è¦é›œéŒ¦è”¬èœæ˜¥å·", "è—¤æ¤’ç‰›è‚‰ç²’ç‚’æ™‚è”¬",
            "æ¸…ç‚–ç™½è˜¿è””ç‰›è‚‰æ¹¯", "æ´‹è”¥è±¬è‚‰è”¬èœæ¹¯é‹", "é›é«€é‚£ä¸å‹’æ–¯æ„ç²‰çƒ¤è”¬èœ", "æª¸æª¬èŠ±æ¤’ç„—ç‰›è‚‰é…æ´‹è”¥å½©æ¤’è•ƒèŒ„ä»”", "é’æ¤’é›è›‹ç‚’è±†è…",
            "å¥§çˆ¾è‰¯é›èƒ¸ä¸æ´‹è”¥ç‚’å½©æ¤’", "å¥§çˆ¾è‰¯é›èƒ¸æ¢", "ç”Ÿèœè•ƒèŒ„ä»”æ²™å¾‹", "æ´‹è”¥å½©æ¤’ç‚’è±¬è‚", "ç…™ä¸‰æ–‡é­šæ»‘è›‹è»Šå˜èŒ„å…¨éº¥å¤šå£«",
            "è’œé¦™ç‰›æŸ³ç²’è˜†ç­é…è–¯ä»”", "è¦ä»è‚‰ç¢æ¤°èœçµ²ç‚’ç²‰çµ²ç…²", "å¾®æ³¢çˆç‰ˆè’œè“‰è¦ä»ç²‰çµ²ç…²", "å¾®æ³¢çˆæ¿éŸ“å¼æ³¡èœé›è‚‰é‹è›‹ç…²", "å¾®æ³¢çˆç‰ˆæ¢…èŠ±è‚‰é…¸æ¹¯å°ç«é‹",
            "å¾®æ³¢çˆç‰ˆå’–å–±æ´‹è”¥ç´…è˜¿è””æ¤°èœèŠ±é­šä¸¸çƒå†¬", "å¾®æ³¢çˆç‰ˆè•ƒèŒ„åŒ…æ²™é­šé­”èŠ‹çµ²è±†è…é‹", "å¾®æ³¢çˆç‰ˆç…§ç‡’é›è…¿è‚‰è”¬èœç…²", "Overnight rolled oats + milk + fruit + chia seeds",
            "æ¸…è’¸è±†è…å¨ƒå¨ƒèœè‚‰é¤…", "æ³•å¼å·´æ–¯å…‹ç‚–é›é…è’Ÿè’»ç±³ (Poulet Basquaise)"
        ];

        function sanitizeName(name) {
            let n = name;
            return n;
        }

        function getCategory(name, type) {
            const n = name.toLowerCase();
            if (type === 'breakfast') return 'æ—©é¤ (Breakfast)';
            if (n.includes('é›') || n.includes('chicken') || n.includes('poulet')) return 'é›è‚‰æ–™ç† (Chicken)';
            if (n.includes('ç‰›') || n.includes('beef') || n.includes('è±¬') || n.includes('pork') || n.includes('è‚‰')) return 'ç´…è‚‰æ–™ç† (Beef/Pork)';
            if (n.includes('è¦') || n.includes('é­š') || n.includes('salmon') || n.includes('shrimp')) return 'æµ·é®®æ–™ç† (Seafood)';
            return 'ç´ é£Ÿ/è¼•é£Ÿ (Veggie/Light)';
        }

        function generateSubtext(name, isLight, type) {
            const n = name.toLowerCase();
            if (type === 'breakfast') return 'é«˜è›‹ç™½æ—©é¤ï¼Œç©©å®šå…¨æ—¥è¡€ç³–ã€‚';
            
            if (isLight) {
                return 'ã€æ¸›è„‚ç‰ˆ 1225kcalã€‘ä½å¡é«˜è›‹ç™½ï¼Œä½¿ç”¨è’Ÿè’»/å°‘æ²¹/ç˜¦è‚‰ã€‚';
            } else {
                return 'ã€Refeedç‰ˆ 1500kcalã€‘é«˜ç¢³æ°´è£œå……ç³–åŸï¼Œé©é‡æ²¹è„‚ã€‚';
            }
        }

        // --- UPDATED INGREDIENT LOGIC FOR SPECIFIC RECIPES ---
        function generateIngredients(name, isLight, type) {
            let ings = [];
            const n = name.toLowerCase();
            
            // --- 1. SPECIAL RECIPES FROM USER ---
            
            // Cajun Chicken
            if (n.includes('cajun') && n.includes('é›')) {
                if (isLight) {
                    return [
                        'å»çš®é›é«€è‚‰ (150g)', 'æ´‹è”¥ (40g) & è’œè“‰', 'è’Ÿè’»é£¯ (150g) æˆ– è’¸è–¯ä»” (150g)',
                        'ä½è„‚ç‰›å¥¶ (1æ¹¯åŒ™) ä»£æ›¿æ·¡å¥¶æ²¹', 'å™´æ²¹ (å°‘è¨±)', 'Cajuné¦™æ–™ç²‰ & æª¸æª¬æ±'
                    ];
                } else {
                    return [
                        'å»çš®é›é«€è‚‰ (180g)', 'æ´‹è”¥ (50g) & è’œè“‰', 'ç™½é£¯ (150g)',
                        'æ·¡å¥¶æ²¹ (1æ¹¯åŒ™)', 'ç…®é£Ÿæ²¹ (1èŒ¶åŒ™)', 'Cajuné¦™æ–™ç²‰ & æª¸æª¬æ±'
                    ];
                }
            }

            // Teriyaki Chicken (Microwave)
            if (n.includes('ç…§ç‡’') && n.includes('é›') && n.includes('å¾®æ³¢')) {
                if (isLight) {
                    return [
                        'å»çš®é›èƒ¸ (100g)', 'ç‰ç±³ç²’ (80g)', 'å¨ƒå¨ƒèœ (80g) & èƒ¡è˜¿è”” (50g)',
                        'ä½éˆ‰ç…§ç‡’é†¬ (5g) + ä»£ç³– (1g)'
                    ];
                } else {
                    return [
                        'å»éª¨é›è…¿æ’ (100g)', 'ç‰ç±³å¡Š (140g)', 'å¨ƒå¨ƒèœ (70g) & èƒ¡è˜¿è””å¡Š (60g)',
                        'ç…§ç‡’æ± (7g)'
                    ];
                }
            }

            // Roasted Cauliflower Romesco
            if (n.includes('romesco') || (n.includes('çƒ¤') && n.includes('æ¤°èœ') && n.includes('sauce'))) {
                if (isLight) {
                    return [
                        'æ¤°èœèŠ± (åŠé¡†/250g)', 'ç´…ç”œæ¤’ (2å€‹)', 'é¢¨ä¹¾ç•ªèŒ„ (2ç‰‡) & çƒ¤æä» (15g)',
                        'æ©„æ¬–æ²¹ (1æ¹¯åŒ™/10ml)', 'ç±³é†‹ & ç…™ç‡»ç”œæ¤’ç²‰'
                    ];
                } else {
                    return [
                        'æ¤°èœèŠ± (åŠé¡†/250g)', 'ç´…ç”œæ¤’ (2å€‹)', 'æ²¹æµ¸ç•ªèŒ„ (1/4æ¯) & æä» (60g)',
                        'æ©„æ¬–æ²¹ (1/4æ¯/30ml)', 'ç´…é…’é†‹ & ç…™ç‡»ç”œæ¤’ç²‰'
                    ];
                }
            }

            // Toscana Salmon
            if (n.includes('toscana') && n.includes('salmon')) {
                if (isLight) {
                    return [
                        'ä¸‰æ–‡é­šæ’/å»çš®é­šæŸ³ (150g)', 'è èœ (50g) & å°ç•ªèŒ„', 'ä½è„‚ç‰›å¥¶ (150ml) å–ä»£æ·¡å¥¶æ²¹',
                        'æ©„æ¬–æ²¹ (1/2èŒ¶åŒ™)', 'æ´‹è”¥ & è’œ'
                    ];
                } else {
                    return [
                        'ä¸‰æ–‡é­šæ’ (200g)', 'è èœ (50g) & å°ç•ªèŒ„', 'æ·¡å¥¶æ²¹ (100ml) + ç‰›å¥¶ (100ml)',
                        'æ©„æ¬–æ²¹ (1æ¹¯åŒ™) + é»ƒæ²¹ (10g)', 'æ´‹è”¥ & è’œ'
                    ];
                }
            }

            // Apple Pork Chop
            if (n.includes('è˜‹æœ') && n.includes('è±¬')) {
                if (isLight) {
                    return [
                        'ç˜¦è±¬æŸ³ (120g)', 'è˜‹æœ (1å€‹, å¸¶çš®)', 'è¥¿è˜­èŠ±/æŠ±å­ç”˜è— (150g)',
                        'èµ¤è—»ç³–é†‡ (5g) & æ©„æ¬–æ²¹ (1/2èŒ¶åŒ™)'
                    ];
                } else {
                    return [
                        'è±¬æ¢…èŠ±è‚‰ (150g)', 'è˜‹æœ (1å€‹, å»çš®)', 'è¥¿è˜­èŠ±/æŠ±å­ç”˜è— (150g)',
                        'ç´…ç³– (10g) & é»ƒæ²¹ (10g)'
                    ];
                }
            }

            // Spicy Salmon Poke
            if (n.includes('poke') && n.includes('salmon')) {
                if (isLight) {
                    return [
                        'åˆºèº«ç´šä¸‰æ–‡é­š (150g)', 'ç†Ÿç±³é£¯/èŠ±æ¤°èœé£¯ (80g)', 'ç‰›æ²¹æœ (50g)',
                        'ä½è„‚å¸Œè‡˜ä¹³é…ª (1æ¹¯åŒ™) å–ä»£è›‹é»ƒé†¬', 'é†¬æ²¹ & æ˜¯æ‹‰å·®é†¬'
                    ];
                } else {
                    return [
                        'åˆºèº«ç´šä¸‰æ–‡é­š (300g)', 'ç†Ÿç±³é£¯ (120g)', 'ç‰›æ²¹æœ (100g)',
                        'è›‹é»ƒé†¬ (2æ¹¯åŒ™) & é†¬æ²¹ & æ˜¯æ‹‰å·®é†¬'
                    ];
                }
            }

            // Green Pepper Chicken
            if (n.includes('èŠ±æ¤’') && n.includes('é›')) {
                if (isLight) {
                    return [
                        'é›èƒ¸è‚‰ (150g)', 'é’è¥¿æ¤’ (100g) & è¾£æ¤’', 'å™´æ²¹ (å°‘è¨±)',
                        'é†ƒæ–™: ç”ŸæŠ½, è ”æ²¹, æ¾±ç²‰ (æ¸›åŠ)'
                    ];
                } else {
                    return [
                        'é›èƒ¸è‚‰/å»çš®é›é«€è‚‰ (180g)', 'é’è¥¿æ¤’ (80g) & è¾£æ¤’', 'ç‚’æ²¹ (1æ¹¯åŒ™)',
                        'é†ƒæ–™: ç”ŸæŠ½, è ”æ²¹, æ¾±ç²‰, æ²¹'
                    ];
                }
            }

            // Miso Udon
            if (n.includes('miso') || (n.includes('å‘³å™Œ') && n.includes('çƒå†¬'))) {
                if (isLight) {
                    return [
                        'ç˜¦è±¬é‡Œè‚Œ (80g) & æ¿è±†è… (80g)', 'è’Ÿè’»çƒå†¬ (120g)', 'æ¤°å¥¶ (50ml) + ç„¡ç³–è±†å¥¶ (50ml)',
                        'æ··åˆè˜‘è‡ (200g) & è¥¿è˜­èŠ± (100g)', 'æ©„æ¬–æ²¹ (1/2æ¹¯åŒ™)'
                    ];
                } else {
                    return [
                        'è±¬é‡Œè‚Œç‰‡ (100g) & æ¿è±†è… (100g)', 'çƒå†¬ (150g)', 'æ¤°å¥¶ (100ml)',
                        'æ··åˆè˜‘è‡ (200g) & è¥¿è˜­èŠ± (80g)', 'æ©„æ¬–æ²¹ (1æ¹¯åŒ™)'
                    ];
                }
            }
            
            // Poulet Basquaise
            if (n.includes('basquaise') || n.includes('å·´æ–¯å…‹')) {
                if (isLight) {
                     return [
                        'å»çš®é›è…¿è‚‰ (140g)', 'è’Ÿè’»ç±³ (1åŒ…) - æ‹Œæ±é£Ÿ', 'ç”œæ¤’ & æ´‹è”¥ & è’œ (150g)',
                        'è¥¿è˜­èŠ± (150g)', 'ç…®é£Ÿæ²¹ (1èŒ¶åŒ™)'
                    ];
                } else {
                     return [
                        'é›è…¿è‚‰ (170g)', 'ç™½é£¯ (150g)', 'ç”œæ¤’ & æ´‹è”¥ & è’œ (150g)',
                        'å·´ç´„ç´ç«è…¿ (1ç‰‡)', 'ç…®é£Ÿæ²¹ (1.5èŒ¶åŒ™)'
                    ];
                }
            }

            // --- 2. GENERIC LOGIC FOR OTHER 90+ RECIPES ---
            
            const meatWeight = isLight ? '120-140g (ç˜¦è‚‰/å»çš®)' : '150-180g'; 
            const oilAmount = isLight ? '1èŒ¶åŒ™/å™´æ²¹' : '1æ¹¯åŒ™';
            const carbSource = isLight ? 'è’Ÿè’»éºµ/èŠ‹çµ²/åŠæ‹³è–¯ä»”' : 'ç™½é£¯/çƒå†¬/è–¯ä»” (1ç¢—)';

            // Protein
            if (n.includes('é›') || n.includes('chicken')) ings.push(`é›è‚‰: ${meatWeight}`);
            else if (n.includes('ç‰›') || n.includes('beef')) ings.push(`ç‰›è‚‰: ${meatWeight}`);
            else if (n.includes('è±¬') || n.includes('pork') || n.includes('è‚‰é¤…')) ings.push(`è±¬è‚‰: ${meatWeight}`);
            else if (n.includes('è¦') || n.includes('shrimp')) ings.push(isLight ? 'è¦ä» (12-15éš»)' : 'è¦ä» (18-20éš»)');
            else if (n.includes('é­š') || n.includes('fish') || n.includes('salmon')) ings.push(`é­šæŸ³: ${meatWeight}`);
            else if (n.includes('è±†è…') || n.includes('tofu')) ings.push(isLight ? 'ç¡¬è±†è… (åŠç›’) + ç˜¦è‚‰ (80g)' : 'ç¡¬è±†è… (1ç›’) + è‚‰é¡ (100g)');
            else if (n.includes('è›‹') || n.includes('egg')) ings.push(isLight ? 'é›è›‹ (2éš») + è›‹ç™½ (1éš»)' : 'é›è›‹ (2éš») + è›‹ç™½ (2éš»)');

            // Veg
            if (n.includes('è¥¿è˜­èŠ±')) ings.push('è¥¿è˜­èŠ± (200g)');
            else if (n.includes('æ¤°èœ')) ings.push('æ¤°èœ (200g)');
            else if (n.includes('è˜‘è‡')) ings.push('è˜‘è‡ (200g)');
            else ings.push('æ™‚ä»¤è”¬èœ (250g)');

            // Carb & Oil (Generic)
            if (type !== 'dinner' || !isLight) { // Allow carbs for lunch or High Flux dinner
                if (n.includes('çƒå†¬')) ings.push(isLight ? 'è’Ÿè’»çƒå†¬ (1åŒ…)' : 'çƒå†¬ (1åŒ…)');
                else if (n.includes('ç²‰çµ²')) ings.push(isLight ? 'é¾å£ç²‰çµ² (30g)' : 'é¾å£ç²‰çµ² (50g)');
                else if (n.includes('è–¯ä»”')) ings.push(isLight ? 'è–¯ä»” (150g)' : 'è–¯ä»” (200g)');
                else ings.push(carbSource);
            } else {
                 ings.push('<span class="text-red-500">æ™šé¤ç„¡æ¾±ç²‰ (åªé£Ÿèœè‚‰)</span>');
            }

            ings.push(`æ²¹è„‚: ${oilAmount}`);

            return ings;
        }

        function generateTip(name, isLight) {
            if (isLight) {
                return 'æ¸›è„‚æ—¥ (1225kcal)ï¼šå°ˆæ³¨è›‹ç™½è³ªèˆ‡çº–ç¶­ï¼Œæ™šé¤é¿å…æ¾±ç²‰ï¼Œä¿æŒè¼•ç›ˆã€‚';
            } else {
                return 'Refeedæ—¥ (1500kcal)ï¼šå¢åŠ ç¢³æ°´æ”å– (é£¯/è–¯ä»”)ï¼Œå¹«åŠ©ä»£è¬å›å‡ï¼Œæ”¾é¬†å¿ƒæƒ…ã€‚';
            }
        }

        const RECIPES = RAW_RECIPES.map((name, index) => {
            const n = name.toLowerCase();
            let type = 'lunch_dinner';
            if (n.includes('oats') || n.includes('toast') || n.includes('sandwich') || n.includes('frittata') || n.includes('breakfast') || index === 93 || index === 84 || index === 0) {
                type = 'breakfast';
            }
            
            let tags = ['standard'];
            if (n.includes('salad') || n.includes('soup') || n.includes('konjac') || n.includes('èŠ‹çµ²') || n.includes('ç²‰çµ²') || n.includes('å¾®æ³¢çˆ') || n.includes('æ¹¯') || n.includes('light') || n.includes('è±†è…') || n.includes('basquaise') || n.includes('å·´æ–¯å…‹')) {
                tags.push('light');
            }

            const cleanName = sanitizeName(name);
            return { 
                id: index, 
                name: cleanName, 
                type: type, 
                tags: tags,
                category: getCategory(cleanName, type)
            };
        });

        // --- State ---
        let appState = {
            currentDayIndex: new Date().getDay(),
            startDayIndex: new Date().getDay(), // Anchor for the slider
            weeklyData: [] 
        };

        // --- Logic ---
        function generateWeeklyPlan() {
            appState.weeklyData = [];
            const breakfastOpts = RECIPES.filter(r => r.type === 'breakfast');
            const mainOpts = RECIPES.filter(r => r.type === 'lunch_dinner');

            const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

            for(let i=0; i<7; i++) {
                let lunch = pick(mainOpts);
                let dinner = pick(mainOpts);
                
                // Force specific recipes on some days for variety
                if (i === 1) lunch = RECIPES.find(r => r.name.includes('Cajun')) || lunch;
                if (i === 3) dinner = RECIPES.find(r => r.name.includes('ç…§ç‡’')) || dinner;

                let attempts = 0;
                while (dinner.id === lunch.id && attempts < 10) {
                    dinner = pick(mainOpts);
                    attempts++;
                }

                // Logic: Saturday is default Refeed (High Flux), others are Diet (Low Flux)
                // User can toggle this manually later.
                const isRefeedDay = (i === 6); // Saturday
                const isLight = !isRefeedDay; 

                appState.weeklyData.push({
                    plan: {
                        breakfast: pick(breakfastOpts),
                        lunch: lunch,
                        dinner: dinner
                    },
                    skipped: { 
                        breakfast: false, 
                        lunch: false, 
                        dinner: false 
                    },
                    water: i === appState.currentDayIndex ? 3 : 0, 
                    brazilNut: true,
                    isLight: isLight, // True = 1225kcal, False = 1500kcal Refeed
                    swapped: { breakfast: false, lunch: false, dinner: false }
                });
            }
        }

        // --- Global Functions ---
        window.toggleMode = function() {
            const dayData = appState.weeklyData[appState.currentDayIndex];
            dayData.isLight = !dayData.isLight; // Toggle between Diet and Refeed
            renderStats();
            renderMeals();
            renderDaySlider(); 
        };

        window.toggleBrazilNut = function() {
            const dayData = appState.weeklyData[appState.currentDayIndex];
            dayData.brazilNut = !dayData.brazilNut;
            renderStats();
            renderNutButton();
            renderMeals();
        };

        window.swapMeal = function(type) {
            const dayData = appState.weeklyData[appState.currentDayIndex];
            const currentId = dayData.plan[type].id;
            
            const pool = type === 'breakfast' 
                ? RECIPES.filter(r => r.type === 'breakfast') 
                : RECIPES.filter(r => r.type === 'lunch_dinner');
            
            let newMeal = pool[Math.floor(Math.random() * pool.length)];
            let attempts = 0;
            while(newMeal.id === currentId && attempts < 10) {
                 newMeal = pool[Math.floor(Math.random() * pool.length)];
                 attempts++;
            }
            
            dayData.plan[type] = newMeal;
            dayData.skipped[type] = false;
            dayData.swapped[type] = true;
            
            renderMeals();
            renderStats();
        };

        window.toggleSkip = function(type) {
            const dayData = appState.weeklyData[appState.currentDayIndex];
            dayData.skipped[type] = !dayData.skipped[type];
            renderMeals();
            renderStats();
        };

        window.setDay = function(d) {
            appState.currentDayIndex = d;
            render();
        };

        window.addWater = function() {
            const dayData = appState.weeklyData[appState.currentDayIndex];
            dayData.water = dayData.water >= 8 ? 8 : dayData.water + 1;
            renderWater();
        };
        
        window.removeWater = function() {
            const dayData = appState.weeklyData[appState.currentDayIndex];
            dayData.water = dayData.water <= 0 ? 0 : dayData.water - 1;
            renderWater();
        };

        window.toggleMenu = function() {
            const modal = document.getElementById('menu-modal');
            const drawer = document.getElementById('menu-drawer');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => drawer.classList.remove('translate-x-full'), 10);
            } else {
                drawer.classList.add('translate-x-full');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        };

        // --- Render Functions ---
        function render() {
            renderDaySlider();
            renderNutButton();
            renderStats();
            renderWater();
            renderMeals();
            renderFullMenu();
        }

        function renderDaySlider() {
            const days = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            const enDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const letters = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            
            let html = '';
            for (let i = 0; i < 7; i++) {
                const dayIndex = (appState.startDayIndex + i) % 7;
                
                const active = dayIndex === appState.currentDayIndex;
                const isLight = appState.weeklyData[dayIndex].isLight;
                
                // Green for Diet Day (1225), Orange for Refeed Day (1500)
                const cornerColor = isLight ? 'bg-emerald-100' : 'bg-orange-100';
                const iconColor = isLight ? 'text-emerald-500' : 'text-orange-500';
                const icon = isLight ? ICONS.leaf : ICONS.fire;
                
                let cardClass = 'day-card-new cursor-pointer ';
                if (active) cardClass += 'day-card-active ';

                let label = enDays[dayIndex];

                html += `
                    <button onclick="window.setDay(${dayIndex})" class="${cardClass}">
                        <div class="corner-badge ${cornerColor}"></div>
                        <div class="h-full flex flex-col justify-between p-2">
                            <div class="text-[10px] font-bold text-gray-400 uppercase leading-none text-left">${label}</div>
                            <div class="flex justify-between items-end">
                                <span class="text-xl font-bold text-gray-800 leading-none">${letters[dayIndex]}</span>
                                <span class="${iconColor} mb-0.5">${icon}</span>
                            </div>
                        </div>
                    </button>
                `;
            }
            document.getElementById('day-slider').innerHTML = html;
        }

        function renderNutButton() {
            const dayData = appState.weeklyData[appState.currentDayIndex];
            const btn = document.getElementById('nut-btn');
            if(dayData.brazilNut) {
                btn.className = "nut-btn flex items-center space-x-1 px-2 py-1 rounded-full border text-[10px] font-bold shadow-sm nut-active";
            } else {
                btn.className = "nut-btn flex items-center space-x-1 px-2 py-1 rounded-full border text-[10px] font-bold shadow-sm nut-inactive";
            }
        }

        function renderStats() {
            const dayData = appState.weeklyData[appState.currentDayIndex];
            const isLight = dayData.isLight; // True = Diet, False = Refeed

            const badge = document.getElementById('day-type-badge');
            badge.innerText = isLight ? 'æ¸›è„‚æ—¥ (DIET)' : 'REFEED DAY';
            badge.className = `px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider ${isLight ? 'bg-emerald-100 text-emerald-600' : 'bg-orange-100 text-orange-600'}`;

            // --- NEW TARGETS ---
            const target = isLight ? 1225 : 1500;
            const pTarget = 115; // Constant protein
            const cTarget = isLight ? 100 : 150; // Higher carbs on Refeed

            let total = 0, pTotal = 0, cTotal = 0;

            if (dayData.brazilNut) {
                total += 33; pTotal += 1; cTotal += 0.5;
            }

            // Distribute calories roughly per meal
            const mealConfigs = {
                diet: { breakfast: 325, lunch: 450, dinner: 450 }, // ~1225
                refeed: { breakfast: 400, lunch: 550, dinner: 550 } // ~1500
            };

            const config = isLight ? {...mealConfigs.diet} : {...mealConfigs.refeed};

            if (dayData.brazilNut) {
                config.lunch -= 11;
                config.dinner -= 11;
                config.breakfast -= 11;
            }

            ['breakfast', 'lunch', 'dinner'].forEach(t => {
                if (!dayData.skipped[t]) {
                    const cal = Math.max(0, config[t]);
                    total += cal;
                    // Rough macro estimation based on calories
                    if (isLight) {
                         pTotal += (cal * 0.40) / 4; // High protein ratio
                         cTotal += (cal * 0.30) / 4; // Moderate carb
                    } else {
                         pTotal += (cal * 0.30) / 4; 
                         cTotal += (cal * 0.45) / 4; // Higher carb ratio
                    }
                }
            });

            const toggleLabel = document.getElementById('mode-label');
            const toggleInput = document.getElementById('mode-toggle');
            
            toggleLabel.innerText = isLight ? 'æ¸›è„‚æ¨¡å¼ (1225)' : 'Refeed æ¨¡å¼ (1500)';
            toggleLabel.className = `text-[10px] font-bold uppercase tracking-wider ${isLight ? 'text-teal-600' : 'text-orange-600'}`;
            toggleInput.checked = !isLight; // Checked = Refeed (Orange)

            // STRATEGY TEXT UPDATE
            document.getElementById('strategy-desc').innerHTML = isLight 
                ? '<span class="font-bold text-teal-700">æ¸›è„‚æ—¥ (1225 kcal)ï¼š</span>æº«å’Œç†±é‡ç¼ºå£ã€‚é‡é»ï¼šé«˜è›‹ç™½ (115g)ã€ä½æ²¹è„‚ (1èŒ¶åŒ™)ã€æ™šé¤ç„¡æ¾±ç²‰ã€‚' 
                : '<span class="font-bold text-orange-700">Refeed æ—¥ (1500 kcal)ï¼š</span>å›å¾©è‡³ TDEE æ°´å¹³ã€‚é‡é»ï¼šå¢åŠ ç¢³æ°´ (ç™½é£¯/è–¯ä»”) è‡³ 150gï¼Œå¹«åŠ©ä»£è¬ Resetï¼Œæ”¾é¬†èº«å¿ƒã€‚';

            document.getElementById('cal-current').innerText = Math.round(total);
            document.getElementById('cal-target').innerText = target;
            
            document.getElementById('prot-current').innerText = Math.round(pTotal);
            document.getElementById('prot-target').innerText = pTarget + 'g';
            
            const pPct = Math.min((pTotal/pTarget)*100, 100);
            document.getElementById('prot-bar').style.width = pPct + '%';
            document.getElementById('prot-bar').className = `h-full rounded-full transition-all duration-700 ${pTotal >= pTarget ? 'bg-green-500' : 'bg-blue-500'}`;
            
            document.getElementById('carb-current').innerText = Math.round(cTotal);
            document.getElementById('carb-target').innerText = cTarget + 'g';
            const cPct = Math.min((cTotal/cTarget)*100, 100);
            document.getElementById('carb-bar').style.width = cPct + '%';
            document.getElementById('carb-bar').className = `h-full rounded-full transition-all duration-700 ${cTotal > cTarget ? 'bg-red-400' : 'bg-yellow-400'}`;
        }

        function renderWater() {
            const dayData = appState.weeklyData[appState.currentDayIndex];
            const container = document.getElementById('water-container');
            
            if (dayData.water >= 8) {
                container.innerHTML = `
                    <div class="water-success-card p-4 flex flex-col items-center justify-center space-y-3">
                        <div class="flex w-full justify-between items-center">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-2xl bg-yellow-100 flex items-center justify-center text-yellow-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12,22c4.97,0,9-4.03,9-9c0-4.97-9-13-9-13S3,8.03,3,13C3,17.97,7.03,22,12,22z"/></svg>
                                </div>
                                <div>
                                    <h3 class="text-sm font-bold text-gray-900">Hydration</h3>
                                    <p class="text-xs text-gray-500 font-medium">8 / 8 Cups</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="window.removeWater()" class="w-8 h-8 rounded-full border border-gray-200 flex items-center justify-center text-gray-400 hover:bg-gray-50">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                </button>
                                <button onclick="window.addWater()" class="w-8 h-8 rounded-full bg-yellow-400 text-white flex items-center justify-center shadow-md shadow-yellow-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                </button>
                            </div>
                        </div>
                        <div class="flex w-full space-x-1 px-1">
                            ${Array(8).fill(0).map(() => `<div class="water-dash"></div>`).join('')}
                        </div>
                        <div class="text-xs font-bold text-yellow-600 tracking-wide">
                            ğŸ‰ ç›®æ¨™é”æˆï¼Excellent!
                        </div>
                    </div>
                `;
            } else {
                let dots = '';
                for(let i=0; i<8; i++) {
                    const filled = i < dayData.water;
                    dots += `<div class="water-dot ${filled ? 'bg-blue-500' : 'bg-gray-100'}"></div>`;
                }
                container.innerHTML = `
                    <div class="bg-white rounded-full p-1 pr-2 shadow-sm border border-gray-100 flex items-center justify-between">
                        <div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-500 flex-shrink-0 ml-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                                <path d="M12,22c4.97,0,9-4.03,9-9c0-4.97-9-13-9-13S3,8.03,3,13C3,17.97,7.03,22,12,22z"/>
                            </svg>
                        </div>
                        <div class="flex space-x-1 mx-2" id="water-dots">
                            ${dots}
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs font-medium text-gray-400 tabular-nums"><span id="water-text" class="text-gray-600 font-bold">${dayData.water * 250}</span>ml</span>
                            <button onclick="window.removeWater()" class="w-8 h-8 rounded-full border border-gray-200 flex items-center justify-center text-gray-400 hover:bg-gray-50 active:scale-95 transition-transform">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            </button>
                            <button onclick="window.addWater()" class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center active:scale-95 transition-transform shadow-md shadow-blue-200">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function renderMeals() {
            const dayData = appState.weeklyData[appState.currentDayIndex];
            const isLight = dayData.isLight; // True = Diet, False = Refeed
            
            const types = [
                { k: 'breakfast', l: 'æ—©é¤', icon: ICONS.coffee },
                { k: 'lunch', l: 'åˆé¤', icon: ICONS.sun },
                { k: 'dinner', l: 'æ™šé¤', icon: ICONS.moon }
            ];

             const mealConfigs = {
                diet: { breakfast: 325, lunch: 450, dinner: 450 },
                refeed: { breakfast: 400, lunch: 550, dinner: 550 }
            };
            
            const config = isLight ? {...mealConfigs.diet} : {...mealConfigs.refeed};

            if (dayData.brazilNut) {
                config.lunch -= 11;
                config.dinner -= 11;
                config.breakfast -= 11;
            }

            const html = types.map(t => {
                const recipe = dayData.plan[t.k];
                const skipped = dayData.skipped[t.k];
                const swapped = dayData.swapped[t.k];
                const displayCals = Math.max(0, config[t.k]);
                
                const ingredients = generateIngredients(recipe.name, isLight, t.k);
                const tip = generateTip(recipe.name, isLight);
                const subtext = generateSubtext(recipe.name, isLight, t.k);

                return `
                    <div class="meal-card p-5 relative overflow-hidden ${skipped ? 'meal-skipped' : ''} ${swapped ? 'animate-fade-in' : ''}">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center space-x-2">
                                <span class="text-xl">${t.icon}</span>
                                <span class="text-base font-bold text-gray-900">${t.l}</span>
                                ${swapped ? '<span class="text-[9px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded font-bold ml-1">âœ¨ å·²æ›´æ–°</span>' : ''}
                            </div>
                            <span class="bg-white border border-gray-100 text-gray-400 text-[10px] font-mono px-2 py-1 rounded">
                                ${displayCals} kcal
                            </span>
                        </div>
                        <div class="mb-4">
                            <div class="flex justify-between items-start">
                                <h3 class="text-base font-bold text-gray-800 leading-tight w-full">${recipe.name}</h3>
                                <div class="flex space-x-1 ml-2 flex-shrink-0">
                                    <button onclick="window.swapMeal('${t.k}')" class="w-6 h-6 rounded-full bg-gray-50 text-gray-400 hover:text-blue-600 flex items-center justify-center">
                                        ${ICONS.refresh}
                                    </button>
                                    <button onclick="window.toggleSkip('${t.k}')" class="w-6 h-6 rounded-full bg-gray-50 text-gray-400 hover:text-red-500 flex items-center justify-center">
                                        ${skipped ? ICONS.restore : ICONS.close}
                                    </button>
                                </div>
                            </div>
                            ${!skipped ? `<p class="text-xs text-gray-500 mt-1">${subtext}</p>` : ''}
                        </div>
                        ${!skipped ? `
                        <div class="space-y-1.5 mb-4 bg-gray-50/50 p-3 rounded-xl border border-gray-50">
                            ${ingredients.map(ing => `
                                <div class="flex items-start space-x-2">
                                    <div class="mt-1">${ICONS.check}</div>
                                    <span class="text-xs text-gray-600">${ing}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="tip-box p-2.5 flex items-start space-x-2">
                            <div class="mt-0.5 flex-shrink-0">${ICONS.bulb}</div>
                            <p class="text-[11px] text-yellow-800/80 leading-relaxed font-medium">
                                ${tip}
                            </p>
                        </div>
                        ` : '<p class="text-xs text-red-400 text-center py-2">æœ¬é¤å·²ç•¥é</p>'}
                    </div>
                `;
            }).join('');
            document.getElementById('meals-container').innerHTML = html;
        }

        function renderFullMenu() {
            const list = document.getElementById('full-menu-list');
            const categories = {};
            RECIPES.forEach(r => {
                if (!categories[r.category]) categories[r.category] = [];
                categories[r.category].push(r);
            });

            const order = ['æ—©é¤ (Breakfast)', 'é›è‚‰æ–™ç† (Chicken)', 'ç´…è‚‰æ–™ç† (Beef/Pork)', 'æµ·é®®æ–™ç† (Seafood)', 'ç´ é£Ÿ/è¼•é£Ÿ (Veggie/Light)'];
            let html = '';
            order.forEach(cat => {
                if(categories[cat]) {
                    html += `
                        <div class="mb-6">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 pl-1 border-b border-gray-100 pb-1">${cat}</h3>
                            <div class="space-y-2">
                                ${categories[cat].map(r => `
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100">
                                        <span class="text-xs font-medium text-gray-800">${r.name}</span>
                                        ${r.tags.includes('light') ? '<span class="text-[9px] bg-emerald-100 text-emerald-600 px-1.5 py-0.5 rounded font-bold">L</span>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            list.innerHTML = html;
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            generateWeeklyPlan();
            render();
        });
    </script>
</body>
</html>
